name: Trim Old Branches

on:
  push:
    branches:
      - ghactions
  repository_dispatch:
    types:
      - all
      - trim
  schedule:
    - cron:  '0 0 * * *' # every day at midnight

jobs:
  trim_branches:
    runs-on: ubuntu-latest

    name: Trim Old Branches

    steps:
      - uses: actions/checkout@v2
        name: GitHub Pull

      - name: Trim Branches
        shell: bash
        # delete branches starting with `gha-`
        # do not delete the most recent 5 branches
        # delete all branches whose latest commit is older than a week.
        run: |
          git config --local --unset http.https://github.com/.extraheader
          git config --local --list
          echo "Branches: `$(git branch -r --sort=-committerdate | awk -F/ '/\/gha-/{print $2}' | tail -n+6`"
          for k in $(git branch -r --sort=-committerdate | awk -F/ '/\/gha-/{print $2}' | tail -n+6); do
            echo "`$(git log -1 --since='1 week ago' -s origin/$k)`"
            if [ -z "$(git log -1 --since='1 week ago' -s origin/$k)" ]; then
              echo "Deleting branch: $k"
              git push https://schloerke:${{secrets.GITHUB_PAT}}@github.com/rstudio/shinycoreci-apps.git --delete $k
            fi
          done
